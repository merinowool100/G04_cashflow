<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashflow</title>
</head>
<body>
<!-- 初期設定ボタン -->
<div class="controls">
    <button id="initialSetupBtn">設定</button>
</div>

<!-- 初期設定ウィンドウ -->
<div id="setup" style="display:none;">
    <label for="initialDate">開始日: </label>
    <input type="date" id="initialDate" required>
    <label for="endDate">終了日: </label>
    <input type="date" id="endDate" required>
    <label for="initialBalance">初期残高: </label>
    <input type="number" id="initialBalance" required>
    <button id="saveSetup">保存</button>
    <button id="clearLocalStorageBtn">全データクリア</button> 
</div>

<form id="inputForm">
    <label for="date">日付</label><input id="date" type="date" required>
    <label for="item">項目</label><input id="item" type="text" required>
    <label for="amount">金額</label><input id="amount" type="number" required>
    <label><input type="checkbox" id="monthly">毎月</label>
    <label><input type="checkbox" id="yearly">毎年</label>
    <button type="submit">追加</button>
</form>

<div id="recordsTable"></div>

<table>
    <thead>
        <tr>
            <th>日付</th>
            <th>項目</th>
            <th>金額</th>
            <th>残高</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    let records = [];

    let initialDate, endDate, initialBalance;

    // localStorage からレコードを読み込む
    const savedRecords = localStorage.getItem("records");
    if (savedRecords) {
        records = JSON.parse(savedRecords);
    }

    const savedSetup = localStorage.getItem("setup");
    if(savedSetup){
        const setupData = JSON.parse(savedSetup);
        initialDate = setupData.initialDate;
        endDate = setupData.endDate;
        initialBalance = setupData.initialBalance;

        document.getElementById("initialDate").value = initialDate;
        document.getElementById("endDate").value = endDate;
        document.getElementById("initialBalance").value = initialBalance;
    }

    // 表示を更新
    displayRecords();

    // 記録を表示する関数
    function displayRecords() {
        const recordsTableBody = document.querySelector("table tbody");
        recordsTableBody.innerHTML = "";

        let balance = 0;

        for (let i = 0; i < records.length; i++) {
            const row = document.createElement("tr");

            const tdDate = document.createElement("td");
            const tdItem = document.createElement("td");
            const tdAmount = document.createElement("td");
            const tdBalance = document.createElement("td");

            tdDate.textContent = records[i].date;
            tdItem.textContent = records[i].item;
            tdAmount.textContent = records[i].amount;

            balance += records[i].amount;
            tdBalance.textContent = balance;

            row.appendChild(tdDate);
            row.appendChild(tdItem);
            row.appendChild(tdAmount);
            row.appendChild(tdBalance);

            recordsTableBody.appendChild(row);
        }
    }

    // チェックボックスをどちらか一方だけ選択できるようにする
    document.getElementById("monthly").addEventListener("change", function() {
        if (this.checked) {
            document.getElementById("yearly").checked = false;  // 毎月が選ばれたら毎年を解除
        }
    });

    document.getElementById("yearly").addEventListener("change", function() {
        if (this.checked) {
            document.getElementById("monthly").checked = false;  // 毎年が選ばれたら毎月を解除
        }
        });



    // 記録をフォームに追加する処理
    document.getElementById("inputForm").addEventListener("submit", (event) => {
        event.preventDefault();

        const date = document.getElementById("date").value;
        const item = document.getElementById("item").value;
        const amount = parseFloat(document.getElementById("amount").value);
        const flag = "none";

        let startDate = new Date(date);
        let endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value):"2030-12-31";

        if (document.getElementById("monthly").checked){
            while (startDate <= endDate){
                records.push({date: startDate.toISOString().split("T")[0],item, amount,flag});
                startDate.setMonth(startDate.getMonth() +1);
            }
        }
        else if (document.getElementById("yearly").checked){
            while (startDate <= endDate){
                records.push({date: startDate.toISOString().split("T")[0],item, amount,flag});
                startDate.setFullYear(startDate.getFullYear() +1);
            }
        } else{
            records.push({ date, item, amount, flag });
        }

        // 日付順に並べ替え
        records.sort((a, b) => new Date(a.date) - new Date(b.date));

        // localStorage に保存
        localStorage.setItem("records", JSON.stringify(records));

        // フォームをリセット
        document.getElementById("inputForm").reset();

        // 表示を更新
        displayRecords();
    });

    // 初期化ボタン（localStorage を消去する）
    document.getElementById("clearLocalStorageBtn").addEventListener("click", () => {
        localStorage.clear();
        location.reload(); // ページをリロードして変更を反映
    });

    // 初期設定ウィンドウの表示/非表示を切り替える
    document.getElementById("initialSetupBtn").addEventListener("click", function() {
        const setupWindow = document.getElementById("setup");
        if (setupWindow.style.display === "none" || setupWindow.style.display === "") {
            setupWindow.style.display = "block";  // 表示
        } else {
            setupWindow.style.display = "none";   // 非表示
        }
    });

    // 設定保存ボタン
    document.getElementById("saveSetup").addEventListener("click", () => {
        initialDate = document.getElementById("initialDate").value;
        initialBalance = parseFloat(document.getElementById("initialBalance").value);
        endDate =  document.getElementById("endDate").value;

        // "init" フラグがついているレコードを削除して新しいレコードを追加
        records = records.filter(record => record.flag !== "init");
        records.push({ date: initialDate, item: "初期残高", amount: initialBalance, flag: "init" });
        records.sort((a, b) => new Date(a.date) - new Date(b.date));

        localStorage.setItem("setup",JSON.stringify({
            initialDate,
            endDate,
            initialBalance,
        }));


        // localStorage に保存
        localStorage.setItem("records", JSON.stringify(records));

        // 設定ウィンドウを非表示にする
        document.getElementById("setup").style.display = "none";

        // 表示を更新
        displayRecords();
    });
</script>

</body>
</html>
