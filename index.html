<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日付順金額管理</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        input, select, button {
            margin: 5px;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls select, .controls button, .controls input {
            padding: 5px 10px;
        }
        .arrows {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arrow-btn {
            margin: 0 10px;
            padding: 5px 10px;
        }
        .month-display {
            font-size: 18px;
        }
        .readonly {
            background-color: #f4f4f4;
            border: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
        }
    </style>
</head>
<body>

<h1>日付順金額管理</h1>

<!-- 初期設定ボタン -->
<div class="controls">
    <button id="initialSetupBtn">初期設定</button>
</div>

<!-- 初期設定ウィンドウ -->
<div id="initialSetupModal" class="modal">
    <div class="modal-content">
        <h2>初期設定</h2>
        <label for="initialBalance">初期残高: </label>
        <input type="number" id="initialBalance" name="initialBalance" required>
        <button id="saveInitialBalance">保存</button>
        <button id="cancelInitialSetup">キャンセル</button>
    </div>
</div>

<!-- 年月選択と矢印ボタン -->
<div class="controls arrows">
    <button id="prevMonth" class="arrow-btn">&lt; 前月</button>
    <span id="monthDisplay" class="month-display"></span>
    <button id="nextMonth" class="arrow-btn">次月 &gt;</button>
</div>

<!-- 入力フォーム -->
<div class="controls">
    <form id="inputForm">
        <label for="day">日: </label>
        <input type="number" id="day" name="day" min="1" max="31" required>
        <label for="item">項目: </label>
        <input type="text" id="item" name="item" required>
        <label for="amount">金額: </label>
        <input type="number" id="amount" name="amount" required>
        <button type="submit">追加</button>
    </form>
</div>

<table id="balanceTable">
    <thead>
        <tr>
            <th>日</th>
            <th>項目</th>
            <th>金額</th>
            <th>残高</th>
        </tr>
    </thead>
    <tbody>
        <!-- データが動的に表示される部分 -->
    </tbody>
</table>

<script>
    let tableData = JSON.parse(localStorage.getItem('tableData')) || [];
    let initialBalance = JSON.parse(localStorage.getItem('initialBalance')) || 0;

    let currentDate = "2024-11";  // 表示する開始年月
    let startDate = "2024-11";    // 開始年月
    let endDate = "2034-10";      // 終了年月（10年間）

    // 初期設定ウィンドウの表示
    const initialSetupModal = document.getElementById('initialSetupModal');
    const initialSetupBtn = document.getElementById('initialSetupBtn');
    const saveInitialBalanceBtn = document.getElementById('saveInitialBalance');
    const cancelInitialSetupBtn = document.getElementById('cancelInitialSetup');
    const initialBalanceInput = document.getElementById('initialBalance');

    initialSetupBtn.addEventListener('click', function() {
        initialSetupModal.style.display = 'flex';
    });

    saveInitialBalanceBtn.addEventListener('click', function() {
        const balance = parseInt(initialBalanceInput.value);
        if (!isNaN(balance)) {
            initialBalance = balance;
            localStorage.setItem('initialBalance', JSON.stringify(initialBalance));

            // 初期残高を繰越行としてテーブルに追加
            tableData = [];
            tableData.push({
                date: "2024-11-01", order: 0, item: "繰越", amount: 0, balance: initialBalance
            });

            // 各月1日の繰越データを作成
            createMonthlyCarryovers();

            localStorage.setItem('tableData', JSON.stringify(tableData));
            initialSetupModal.style.display = 'none';
            renderTable();
        }
    });

    cancelInitialSetupBtn.addEventListener('click', function() {
        initialSetupModal.style.display = 'none';
    });

    // 月の選択
    function setDateRange() {
        updateMonthDisplay();
        renderTable();
        updateArrowButtons();
    }

    // 月表示の更新
    function updateMonthDisplay() {
        const monthDisplay = document.getElementById('monthDisplay');
        monthDisplay.textContent = currentDate;
    }

    // 前月、次月ボタンの表示/非表示を制御
    function updateArrowButtons() {
        const prevButton = document.getElementById('prevMonth');
        const nextButton = document.getElementById('nextMonth');

        if (currentDate === startDate) {
            prevButton.style.display = 'none';
        } else {
            prevButton.style.display = 'inline-block';
        }

        if (currentDate === endDate) {
            nextButton.style.display = 'none';
        } else {
            nextButton.style.display = 'inline-block';
        }
    }

    // 月を進める（次月）
    function nextMonth() {
        const [year, month] = currentDate.split('-').map(Number);
        let newMonth = month + 1;
        let newYear = year;
        if (newMonth > 12) {
            newMonth = 1;
            newYear++;
        }
        const newDate = `${newYear}-${String(newMonth).padStart(2, '0')}`;

        if (newDate <= endDate) {
            currentDate = newDate;
            updateMonthDisplay();
            updateArrowButtons();
            renderTable();
        }
    }

    // 月を戻す（前月）
    function prevMonth() {
        const [year, month] = currentDate.split('-').map(Number);
        let newMonth = month - 1;
        let newYear = year;
        if (newMonth < 1) {
            newMonth = 12;
            newYear--;
        }
        const newDate = `${newYear}-${String(newMonth).padStart(2, '0')}`;

        if (newDate >= startDate) {
            currentDate = newDate;
            updateMonthDisplay();
            updateArrowButtons();
            renderTable();
        }
    }

    // 入力フォームの送信イベントを監視
    document.getElementById('inputForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const day = parseInt(document.getElementById('day').value);
        const item = document.getElementById('item').value;
        const amount = parseInt(document.getElementById('amount').value);

        const order = getOrderForSameDay(currentDate, day);

        const newRow = { 
            date: `${currentDate}-${String(day).padStart(2, '0')}`,
            order, 
            item, 
            amount, 
            balance: 0 
        };

        const lastBalance = getLastBalanceFromPreviousMonth(currentDate);
        newRow.balance = lastBalance + newRow.amount;

        tableData.push(newRow);

        tableData.sort((a, b) => a.date.localeCompare(b.date) || a.order - b.order);

        // 残高計算
        for (let i = 1; i < tableData.length; i++) {
            tableData[i].balance = tableData[i - 1].balance + tableData[i].amount;
        }

        localStorage.setItem('tableData', JSON.stringify(tableData));

        renderTable();

        document.getElementById('day').value = '';
        document.getElementById('item').value = '';
        document.getElementById('amount').value = '';
    });

    // 同じ日付のデータの中で、orderの番号を決定
    function getOrderForSameDay(date, day) {
        const sameDayData = tableData.filter(row => row.date === `${date}-${String(day).padStart(2, '0')}`);
        return sameDayData.length;
    }

    // 前月の残高を取得
    function getLastBalanceFromPreviousMonth(date) {
        const previousMonthDate = getPreviousMonthDate(date);
        const previousMonthData = tableData.filter(row => row.date.startsWith(previousMonthDate));

        if (previousMonthData.length > 0) {
            const lastRecord = previousMonthData.reduce((prev, current) => prev.date > current.date ? prev : current);
            return lastRecord.balance;
        }

        return initialBalance; // 初期残高を使用
    }

    // 前月の年月を取得
    function getPreviousMonthDate(date) {
        const [year, month] = date.split('-').map(Number);
        let newMonth = month - 1;
        let newYear = year;
        if (newMonth < 1) {
            newMonth = 12;
            newYear--;
        }
        return `${newYear}-${String(newMonth).padStart(2, '0')}`;
    }

    // 各月の1日の繰越データを作成
    function createMonthlyCarryovers() {
        let currentBalance = initialBalance;

        for (let year = 2024; year <= 2034; year++) {
            for (let month = 1; month <= 12; month++) {
                const monthStr = `${year}-${String(month).padStart(2, '0')}`;
                const carryoverDate = `${monthStr}-01`;

                if (!tableData.some(row => row.date === carryoverDate)) {
                    tableData.push({
                        date: carryoverDate,
                        order: 0,
                        item: "繰越",
                        amount: 0,
                        balance: currentBalance
                    });
                }
                // 次月の繰越残高を更新
                currentBalance = currentBalance;
            }
        }

        localStorage.setItem('tableData', JSON.stringify(tableData));
    }

    // 表示されるテーブルを描画
    function renderTable() {
        const tbody = document.querySelector('#balanceTable tbody');
        tbody.innerHTML = '';

        const filteredData = tableData.filter(row => row.date.startsWith(currentDate));

        filteredData.forEach(row => {
            const tr = document.createElement('tr');
            const balanceEditable = row.date === `${currentDate}-01` ? 'contenteditable="true"' : '';
            tr.innerHTML = `
                <td>${row.date.split('-')[2]}</td>
                <td>${row.item}</td>
                <td>${row.amount}</td>
                <td ${balanceEditable}>${row.balance}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 初期化
    setDateRange();

    document.getElementById('prevMonth').addEventListener('click', prevMonth);
    document.getElementById('nextMonth').addEventListener('click', nextMonth);

</script>

</body>
</html>
